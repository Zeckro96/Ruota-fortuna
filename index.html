<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#121826" />
  <title>Ruota Cinnabar Lab</title>

  <link rel="manifest" href="manifest.json" />
  <link rel="apple-touch-icon" href="icons/icon-192.png" />
  <link rel="icon" href="pittogramma-favicon.jpg" />
  <link rel="shortcut icon" href="pittogramma-favicon.jpg" />

  <style>
    :root { --bg:#0b0f14; --panel:#121826; --text:#e8eef6; --muted:#9fb0c3; --accent:#6aa6ff; --accent-dark:#5596e8; }
    *{ box-sizing:border-box; }
    body{ margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif; background:var(--bg); color:var(--text); transition:background 0.3s ease; }
    .safe { padding: max(14px, env(safe-area-inset-top)) max(14px, env(safe-area-inset-right)) max(16px, env(safe-area-inset-bottom)) max(14px, env(safe-area-inset-left)); }

    .app{
      max-width: 980px;
      margin: 0 auto;
      display: grid;
      gap: 16px;
    }

    /* Mobile-first: ruota sopra, controlli sotto. Su desktop affianca */
    @media (min-width: 900px){
      .app{
        grid-template-columns: 1fr 1fr;
        align-items: start;
      }
    }

    .card{ 
      background:var(--panel); 
      border:1px solid rgba(255,255,255,.08); 
      border-radius:20px; 
      padding:20px;
      transition: all 0.2s ease;
      box-shadow: 0 8px 32px rgba(0,0,0,.3);
    }
    .card:hover { border-color:rgba(255,255,255,.15); }
    
    h1{ margin:0 0 12px; font-size:18px; letter-spacing:.2px; font-weight:700; }
    h2{ margin:0 0 14px; font-size:16px; letter-spacing:.1px; font-weight:600; }
    .muted{ color:var(--muted); font-size:13px; line-height:1.5; }

    .wheelWrap{ position:relative; margin-bottom:16px; }
    .pointer{
      position:absolute; left:50%; top:8px; transform: translateX(-50%);
      width:0;height:0;border-left:16px solid transparent;border-right:16px solid transparent;border-top:24px solid var(--accent);
      filter: drop-shadow(0 8px 12px rgba(106,166,255,.4));
      z-index:2;
      animation: pulse-pointer 0.6s ease-in-out infinite;
    }
    @keyframes pulse-pointer {
      0%, 100% { filter: drop-shadow(0 8px 12px rgba(106,166,255,.4)); }
      50% { filter: drop-shadow(0 8px 20px rgba(106,166,255,.7)); }
    }
    canvas{ width:100%; height:auto; display:block; border-radius:16px; background: radial-gradient(circle at 30% 20%, rgba(255,255,255,0.03), rgba(0,0,0,0) 30%); box-shadow: 0 12px 40px rgba(0,0,0,.5), inset 0 -8px 24px rgba(0,0,0,.16); }

    /* Win overlay + confetti */
    .wheelWrap{ position:relative; }
    #confetti{ position:absolute; inset:0; pointer-events:none; overflow:hidden; z-index:5; }
    .confetti-piece{
      position:absolute; width:10px; height:16px; opacity:0.95; will-change: transform, opacity;
      transform-origin: center;
      animation: confetti-fall linear forwards;
    }
    @keyframes confetti-fall{
      0%{ transform: translateY(-10%) rotate(0deg) translateX(0px); opacity:1; }
      100%{ transform: translateY(110%) rotate(720deg) translateX(var(--tx)); opacity:0.92; }
    }

    .winOverlay{
      position:absolute; left:50%; top:50%; transform:translate(-50%,-50%) scale(.95);
      background: linear-gradient(180deg, rgba(10,14,20,0.9), rgba(18,24,38,0.85));
      padding:18px 22px; border-radius:14px; text-align:center; z-index:6; display:flex; gap:12px; align-items:center;
      box-shadow: 0 20px 60px rgba(0,0,0,0.6); backdrop-filter: blur(6px);
      opacity:0; transition: opacity .25s ease, transform .35s cubic-bezier(.2,.9,.2,1);
      pointer-events:auto; color:var(--text);
    }
    .winOverlay.show{ opacity:1; transform:translate(-50%,-50%) scale(1); }
    .winText{ font-weight:900; font-size:18px; color: #fff; text-shadow: 0 2px 8px rgba(0,0,0,0.55); }
    .winOverlay .smallBtn{ background:transparent; border:1px solid rgba(255,255,255,0.12); color:var(--text); }

    .btnRow{ display:flex; gap:12px; flex-wrap:wrap; margin-top:14px; }
    button{
      appearance:none;
      border:0;
      border-radius:14px;
      padding:14px 18px;
      font-weight:800;
      font-size:15px;
      cursor:pointer;
      background:linear-gradient(135deg, var(--accent), var(--accent-dark));
      color:#06101f;
      min-height:48px;
      flex: 1 1 auto;
      transition: all 0.2s ease;
      box-shadow: 0 4px 12px rgba(106,166,255,.25);
      position: relative;
      overflow: hidden;
    }
    button:hover:not(:disabled){ 
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(106,166,255,.4);
    }
    button:active:not(:disabled){ transform: translateY(0); }
    button.secondary{
      background:transparent;
      color:var(--text);
      border:1.5px solid rgba(255,255,255,.25);
      font-weight:700;
      flex: 0 0 auto;
      box-shadow: none;
    }
    button.secondary:hover:not(:disabled){
      border-color:rgba(255,255,255,.5);
      background: rgba(255,255,255,.05);
      transform: translateY(-1px);
    }
    button:disabled{ opacity:.5; cursor:not-allowed; }

    .result{
      margin-top:12px;
      font-size:16px;
      font-weight:700;
      padding:14px 16px;
      border-radius:14px;
      background:linear-gradient(135deg, rgba(106,166,255,.15), rgba(106,166,255,.08));
      border:1.5px solid rgba(106,166,255,.3);
      display:none;
      animation: slideIn 0.3s ease;
      color: var(--accent);
    }
    @keyframes slideIn {
      from { opacity:0; transform: translateY(-8px); }
      to { opacity:1; transform: translateY(0); }
    }

    .kpi{ display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-top:14px; }
    .kpi .box{ 
      padding:12px 14px; 
      border-radius:14px; 
      background:linear-gradient(135deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border:1px solid rgba(255,255,255,.12);
      transition: all 0.2s ease;
    }
    .kpi .box:hover { border-color:rgba(255,255,255,.25); background:linear-gradient(135deg, rgba(255,255,255,.10), rgba(255,255,255,.05)); }
    .kpi .box b{ display:block; font-size:11px; color:var(--muted); margin-bottom:6px; text-transform: uppercase; letter-spacing: 0.5px; }
    .kpi .box span{ font-size:16px; font-weight:800; color:var(--accent); }

    /* Public mode: solo ruota + gira */
    .publicOnly { display:block; }
    .staffOnly { display:none; }
    body.staffUnlocked .staffOnly { display:block; }
    body.staffUnlocked .publicOnly { display:none; }

    textarea{
      width:100%;
      min-height: 220px;
      resize: vertical;
      border-radius:14px;
      border:1.5px solid rgba(255,255,255,.15);
      background:#0e1523;
      color:var(--text);
      padding:12px 14px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size:13px;
      transition: all 0.2s ease;
    }
    textarea:focus {
      outline: none;
      border-color:var(--accent);
      box-shadow: 0 0 0 3px rgba(106,166,255,.1);
    }

    .row{ display:flex; gap:12px; flex-wrap:wrap; align-items:center; margin-top:12px; }
    input[type="password"]{
      flex:1 1 220px;
      min-height:48px;
      border-radius:14px;
      border:1.5px solid rgba(255,255,255,.15);
      background:#0e1523;
      color:var(--text);
      padding:12px 14px;
      font-size:14px;
      transition: all 0.2s ease;
    }
    input[type="password"]:focus {
      outline: none;
      border-color:var(--accent);
      box-shadow: 0 0 0 3px rgba(106,166,255,.1);
    }
    
    .pill{
      display:inline-block;
      padding:8px 12px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.2);
      background: rgba(255,255,255,.05);
      font-size:12px;
      color:var(--muted);
      animation: glow 2s ease-in-out infinite;
    }
    @keyframes glow {
      0%, 100% { background:rgba(255,255,255,.05); }
      50% { background:rgba(255,255,255,.08); }
    }

    .topBar{
      display:flex; justify-content:space-between; align-items:center; gap:12px;
      margin-bottom:14px;
    }
    .smallBtn{
      padding:10px 14px;
      border-radius:12px;
      min-height:44px;
      font-size:13px;
    }

    /* Staff panel improvements */
    .itemList {
      display: grid;
      gap: 10px;
      margin-top: 14px;
      max-height: 350px;
      overflow-y: auto;
      padding-right: 4px;
    }

    .itemList::-webkit-scrollbar {
      width: 6px;
    }

    .itemList::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 10px;
    }

    .itemList::-webkit-scrollbar-thumb {
      background: rgba(106, 166, 255, 0.3);
      border-radius: 10px;
    }

    .itemList::-webkit-scrollbar-thumb:hover {
      background: rgba(106, 166, 255, 0.5);
    }

    .item {
      display: flex;
      gap: 10px;
      align-items: center;
      padding: 12px 14px;
      border-radius: 12px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(106, 166, 255, 0.2);
      transition: all 0.2s ease;
    }

    .item:hover {
      background: rgba(255, 255, 255, 0.08);
      border-color: rgba(106, 166, 255, 0.4);
    }

    .item-color {
      width: 20px;
      height: 20px;
      border-radius: 4px;
      flex-shrink: 0;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .item-content {
      flex: 1;
      min-width: 0;
    }

    .item-label {
      font-size: 13px;
      font-weight: 600;
      color: var(--text);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .item-weight {
      font-size: 12px;
      color: var(--muted);
    }

    .item-actions {
      display: flex;
      gap: 6px;
      flex-shrink: 0;
    }

    .item-actions button {
      padding: 6px 10px;
      min-height: auto;
      font-size: 12px;
      flex: 0 0 auto;
    }

    .addItemForm {
      display: grid;
      gap: 10px;
      padding: 14px;
      border-radius: 12px;
      background: rgba(106, 166, 255, 0.08);
      border: 1px solid rgba(106, 166, 255, 0.2);
      margin-top: 14px;
    }

    .formRow {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .formRow input {
      flex: 1;
      min-width: 120px;
      min-height: 40px;
      border-radius: 10px;
      border: 1.5px solid rgba(255, 255, 255, 0.15);
      background: #0e1523;
      color: var(--text);
      padding: 8px 12px;
      font-size: 13px;
    }

    .formRow input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(106, 166, 255, 0.1);
    }

    .formRow label {
      display: block;
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 4px;
    }

    /* Miglioramenti per mobile */
    @media (max-width: 640px) {
      .card { padding:16px; }
      h1 { font-size:16px; }
      button { min-height:48px; padding:12px 16px; }
      .btnRow { gap:10px; }
      .kpi { gap:10px; }
    }
  </style>
</head>
<body>
  <div class="safe">
    <div class="app">
      <!-- PUBLIC / PLAYER VIEW -->
      <div class="card">
        <div class="topBar">
          <h1>Ruota Cinnabar Lab</h1>
          <button class="secondary smallBtn" id="staffBtn" title="Area staff">Staff</button>
        </div>

        <div class="wheelWrap">
          <div class="pointer" aria-hidden="true"></div>
          <canvas id="wheel" width="900" height="900" aria-label="ruota"></canvas>
          <div id="confetti" aria-hidden="true"></div>
          <div id="winOverlay" class="winOverlay" aria-hidden="true">
            <div class="winText" id="winText">üéâ Premio</div>
            <button id="closeWinBtn" class="smallBtn secondary">Chiudi</button>
          </div>
        </div>

        <div class="btnRow">
          <button id="spinBtn">GIRA</button>
          <button class="secondary" id="resetBtn">Reset</button>
        </div>

        <div id="result" class="result"></div>

        <div class="kpi">
          <div class="box"><b>Settori (visivi)</b><span id="nSlices">‚Äì</span></div>
          <div class="box"><b>Somma pesi</b><span id="sumWeights">‚Äì</span></div>
        </div>

        <p class="muted" style="margin:10px 0 0">
          Settori tutti uguali. Probabilit√† gestita dai pesi (weight).
        </p>
      </div>

      <!-- STAFF PANEL (locked by default) -->
      <div class="card">
        <div class="publicOnly">
          <h1>Area staff (bloccata)</h1>
          <p class="muted">
            Inserisci la password per modificare i pesi. Per eventi live √® consigliato lasciare la ruota in modalit√† pubblica.
          </p>
          <div class="row">
            <input id="pw" type="password" placeholder="Password staff" autocomplete="current-password" />
            <button class="secondary" id="unlockBtn">Sblocca</button>
          </div>
          <p class="muted">
            Nota: la protezione √® lato-client (serve per evitare modifiche accidentali, non per sicurezza ‚Äúmilitare‚Äù).
          </p>
          <p class="muted"><span class="pill" id="installHint">Suggerimento: puoi installarla come app (PWA).</span></p>
        </div>

        <div class="staffOnly">
          <div class="topBar">
            <h1>Area staff</h1>
            <button class="secondary smallBtn" id="lockBtn">Blocca</button>
          </div>

          <p class="muted">
            Aggiungi o modifica i settori della ruota. Ogni settore ha un'etichetta e un peso (probabilit√†).
          </p>

          <div id="itemList" class="itemList"></div>

          <div class="addItemForm">
            <div style="display: grid; gap: 6px;">
              <label style="font-size: 12px; color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px;">Nuovo settore</label>
            </div>
            <div class="formRow">
              <div style="flex: 1; min-width: 180px;">
                <input type="text" id="newLabel" placeholder="Etichetta (es. Bustina)" maxlength="40" />
              </div>
              <div style="flex: 0 0 120px;">
                <input type="number" id="newWeight" placeholder="Peso" min="0.1" step="0.5" value="1" />
              </div>
              <button class="secondary" id="addItemBtn" style="flex: 0 0 auto; padding: 8px 14px; min-height: 40px;">+ Aggiungi</button>
            </div>
          </div>

          <div style="margin-top:12px; display:flex; gap:8px; align-items:center;">
            <label for="presetSelect" style="font-size:13px; color:var(--muted); min-width:72px;">Preset</label>
            <select id="presetSelect" style="flex:1; min-height:40px; border-radius:10px; border:1.5px solid rgba(255,255,255,.12); background:#0e1523; color:var(--text); padding:6px 10px;"></select>
            <button class="secondary" id="loadPresetBtn" title="Carica preset">Carica</button>
            <button class="secondary" id="savePresetBtn" title="Salva preset">Salva</button>
            <button class="secondary" id="deletePresetBtn" title="Elimina preset">Elimina</button>
            <button class="secondary" id="clearBtn" title="Azzera ruota">Azzera</button>
          </div>

          <div class="row" style="margin-top:10px;">
            <button class="secondary" id="presetBtn">Ripristina pesi</button>
            <button class="secondary" id="copyLinkBtn">Copia link condivisibile</button>
          </div>

          <p class="muted">
            Consiglio operativo: se usi ‚ÄúRespin‚Äù, considera se farlo girare subito oppure dare un gettone ‚ÄúRespin‚Äù da usare quando vuoi.
          </p>
        </div>
      </div>
    </div>
  </div>

<script>
/**
 * PWA + Ruota: settori uguali, estrazione pesata.
 * Staff mode protetta da password (hash SHA-256).
 */

// ====== CONFIG: cambia qui la password staff (hash SHA-256) ======
// Se vuoi cambiarla: calcola SHA-256 della nuova password e incollalo qui.
const STAFF_PASSWORD_SHA256_HEX = "6e965884ed589f7e22ac394159e67dcaa1243ebc17454efb3b2654aca5c3c725";

// ====== Default preset (tuoi pesi) ======
const PRESET_TEXT = [
  "Bustina espansione | 4,5",
  "Promo foil lega | 20",
  "Punto pass | 5",
  "Bustina di lega ultima serie | 35",
  "Bustina di lega serie x | 20",
  "Promo staff | 0,5",
  "Maxibusta con promo pre | 5",
  "Respin | 10"
].join("\n");

// ====== Preset manager ======
const DEFAULT_PRESETS = [
  { name: 'Test A', text: [
    'TestA - Piccolo premio | 2',
    'TestA - Medio premio | 8',
    'TestA - Grande premio | 20'
  ].join('\n') },
  { name: 'Test B', text: [
    'TestB - Entry | 10',
    'TestB - Bonus | 5',
    'TestB - Jackpot | 1'
  ].join('\n') }
];

function loadPresetsFromStorage(){
  try{
    const raw = localStorage.getItem('wheel_presets');
    const custom = raw ? JSON.parse(raw) : [];
    return [...DEFAULT_PRESETS, ...custom];
  }catch(e){ return [...DEFAULT_PRESETS]; }
}

function savePresetsToStorage(customPresets){
  localStorage.setItem('wheel_presets', JSON.stringify(customPresets));
}

function renderPresetsDropdown(){
  const sel = document.getElementById('presetSelect');
  if (!sel) return;
  const list = loadPresetsFromStorage();
  sel.innerHTML = '';
  list.forEach((p, i) => {
    const opt = document.createElement('option');
    opt.value = p.name;
    opt.textContent = p.name + (i < DEFAULT_PRESETS.length ? ' (default)' : '');
    sel.appendChild(opt);
  });
  // select first by default
  if (sel.options.length) sel.value = sel.options[0].value;
}

function findPresetByName(name){
  const list = loadPresetsFromStorage();
  return list.find(p => p.name === name) || null;
}

function loadPresetByName(name){
  const p = findPresetByName(name);
  if (!p) { setResult('Preset non trovato'); return; }
  options = parseCfg(p.text);
  updateKpi();
  renderItemList();
  syncTextarea();
  localStorage.setItem('wheel_cfg', p.text);
  draw();
  setResult('‚úì Preset caricato: ' + p.name);
}

function saveNewPreset(){
  const sel = document.getElementById('presetSelect');
  const name = prompt('Nome preset:');
  if (!name) return;
  const text = optionsToText();
  const custom = loadPresetsFromStorage().slice(DEFAULT_PRESETS.length);
  // overwrite if exists in custom
  const idx = custom.findIndex(p => p.name === name);
  if (idx >= 0) custom[idx] = { name, text }; else custom.push({ name, text });
  savePresetsToStorage(custom);
  renderPresetsDropdown();
  setResult('‚úì Preset salvato: ' + name);
}

function deleteSelectedPreset(){
  const sel = document.getElementById('presetSelect');
  if (!sel) return;
  const name = sel.value;
  // prevent deleting defaults
  if (DEFAULT_PRESETS.some(p => p.name === name)) { setResult('Impossibile eliminare preset di default'); return; }
  if (!confirm('Eliminare preset ' + name + '?')) return;
  const custom = loadPresetsFromStorage().slice(DEFAULT_PRESETS.length).filter(p => p.name !== name);
  savePresetsToStorage(custom);
  renderPresetsDropdown();
  setResult('‚úì Preset eliminato: ' + name);
}

function clearOptions(){
  if (!confirm('Sei sicuro di voler azzerare tutti gli spicchi?')) return;
  options = [];
  localStorage.removeItem('wheel_cfg');
  updateKpi();
  renderItemList();
  syncTextarea();
  draw();
  setResult('‚úì Ruota azzerata');
}

// ====== Elements ======
const canvas = document.getElementById('wheel');
const ctx = canvas.getContext('2d');

const spinBtn = document.getElementById('spinBtn');
const resetBtn = document.getElementById('resetBtn');
const staffBtn = document.getElementById('staffBtn');

const pwInput = document.getElementById('pw');
const unlockBtn = document.getElementById('unlockBtn');
const lockBtn = document.getElementById('lockBtn');

const itemListEl = document.getElementById('itemList');
const newLabelInput = document.getElementById('newLabel');
const newWeightInput = document.getElementById('newWeight');
const addItemBtn = document.getElementById('addItemBtn');

const presetBtn = document.getElementById('presetBtn');
const copyLinkBtn = document.getElementById('copyLinkBtn');

const resultEl = document.getElementById('result');
const nSlicesEl = document.getElementById('nSlices');
const sumWeightsEl = document.getElementById('sumWeights');
const confettiContainer = document.getElementById('confetti');
const winOverlay = document.getElementById('winOverlay');
const winText = document.getElementById('winText');
const closeWinBtn = document.getElementById('closeWinBtn');

// ====== State ======
let options = [];
let angle = 0;
let spinning = false;

// ====== Helpers ======
function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }

function parseWeight(raw){
  const norm = String(raw ?? '').trim().replace(',', '.');
  const w = Number(norm);
  return w;
}

function parseCfg(text){
  const lines = text.split(/\r?\n/).map(x => x.trim()).filter(Boolean);
  const out = [];
  for (const line of lines){
    const parts = line.split('|').map(x => x.trim());
    const label = (parts[0] ?? '').slice(0, 60);
    const weight = parseWeight(parts[1] ?? 1);
    if (!label) continue;
    if (!Number.isFinite(weight) || weight <= 0) continue;
    out.push({ label, weight });
  }
  return out;
}

function weightedPickIndex(opts){
  const total = opts.reduce((s,o) => s + o.weight, 0);
  const u = crypto.getRandomValues(new Uint32Array(1))[0] / 2**32;
  let r = u * total;
  for (let i=0;i<opts.length;i++){
    r -= opts[i].weight;
    if (r < 0) return i;
  }
  return opts.length - 1;
}

function getPalette(n){
  // ritorna i soli valori di hue; le stringhe colore vengono create al momento dell'uso
  const hues = [];
  for (let i=0;i<n;i++){
    const hue = (i * (360 / n)) % 360;
    hues.push(hue);
  }
  return hues;
}

function setResult(text){
  resultEl.style.display = 'block';
  resultEl.textContent = text;
}

// ====== Win animation (confetti + overlay) ======
function launchConfetti(count = 40){
  if (!confettiContainer) return;
  const n = Math.max(8, count);
  const sw = confettiContainer.clientWidth;
  for (let i=0;i<n;i++){
    const el = document.createElement('div');
    el.className = 'confetti-piece';
    const hue = Math.floor(Math.random() * 360);
    el.style.background = `hsl(${hue} 78% 52%)`;
    const left = Math.random() * 100;
    el.style.left = left + '%';
    // random horizontal travel
    const tx = (Math.random() - 0.5) * 200 + 'px';
    el.style.setProperty('--tx', tx);
    // random size
    const w = 6 + Math.round(Math.random() * 12);
    const h = Math.round(w * (1.2 + Math.random()*0.6));
    el.style.width = w + 'px';
    el.style.height = h + 'px';
    // duration and delay
    const dur = 2800 + Math.round(Math.random() * 2200);
    el.style.animationDuration = dur + 'ms';
    el.style.animationDelay = Math.round(Math.random() * 300) + 'ms';
    confettiContainer.appendChild(el);
    // cleanup
    setTimeout(() => { el.remove(); }, dur + 800);
  }
}

function showWinOverlay(text){
  if (!winOverlay) return;
  winText.textContent = text;
  winOverlay.classList.add('show');
  // launch confetti
  launchConfetti(48);
  // auto-hide after some time
  setTimeout(() => { hideWinOverlay(); }, 6000);
}

function hideWinOverlay(){
  if (!winOverlay) return;
  winOverlay.classList.remove('show');
  // clear remaining confetti nodes
  if (confettiContainer) confettiContainer.innerHTML = '';
}

closeWinBtn?.addEventListener('click', hideWinOverlay);

function updateKpi(){
  nSlicesEl.textContent = options.length.toString();
  sumWeightsEl.textContent = options.reduce((s,o)=>s+o.weight,0).toString();
}

function draw(){
  const w = canvas.width, h = canvas.height;
  ctx.clearRect(0,0,w,h);

  const cx = w/2, cy = h/2;
  const r = Math.min(w,h)*0.44;

  // shadow ring
  ctx.save();
  ctx.translate(cx, cy);
  ctx.beginPath();
  ctx.arc(0,0,r+18,0,Math.PI*2);
  ctx.strokeStyle = 'rgba(0,0,0,.35)';
  ctx.lineWidth = 40;
  ctx.stroke();
  ctx.restore();

  if (!options.length){
    ctx.save();
    ctx.translate(cx, cy);
    ctx.fillStyle = 'rgba(255,255,255,.08)';
    ctx.beginPath();
    ctx.arc(0,0,r,0,Math.PI*2);
    ctx.fill();
    ctx.fillStyle = 'rgba(255,255,255,.6)';
    ctx.textAlign = 'center';
    ctx.font = '700 28px system-ui';
    ctx.fillText('Config mancante', 0, -6);
    ctx.font = '400 16px system-ui';
    ctx.fillText('Apri area staff', 0, 22);
    ctx.restore();
    return;
  }

  const n = options.length;
  const slice = (Math.PI*2)/n;
  const hues = getPalette(n);

  ctx.save();
  ctx.translate(cx, cy);
  ctx.rotate(angle);

  for (let i=0;i<n;i++){
    const start = i*slice;
    const end = start + slice;
    const hue = hues[i];

    // gradient per settore (pi√π chiaro al centro, pi√π scuro al bordo)
    const grad = ctx.createRadialGradient(0,0,r*0.15, 0,0, r);
    grad.addColorStop(0, `hsl(${hue}, 85%, 72%)`);
    grad.addColorStop(0.6, `hsl(${hue}, 72%, 48%)`);
    grad.addColorStop(1, `hsl(${hue}, 62%, 30%)`);

    ctx.beginPath();
    ctx.moveTo(0,0);
    ctx.arc(0,0,r,start,end);
    ctx.closePath();
    ctx.fillStyle = grad;
    ctx.fill();

    // bordo leggero per separazione
    ctx.strokeStyle = 'rgba(0,0,0,0.18)';
    ctx.lineWidth = 2.5;
    ctx.stroke();

    // etichetta: ombra + testo chiaro per contrasto
    ctx.save();
    ctx.rotate(start + slice/2);
    ctx.translate(r*0.68, 0);
    ctx.rotate(Math.PI/2);
    ctx.textAlign = 'center';
    const label = options[i].label;

    // Calcola larghezza disponibile per la label (approssimazione tangenziale)
    const textRadius = r * 0.68;
    const availableWidth = Math.max(8, Math.abs(slice) * textRadius * 0.9);

    // Scegli la massima font-size che entra (tra 18 e 10)
    let fontSize = 18;
    let fontSpec = '';
    for (; fontSize >= 10; fontSize--) {
      fontSpec = `900 ${fontSize}px system-ui`;
      ctx.font = fontSpec;
      if (ctx.measureText(label).width <= availableWidth) break;
    }

    let displayText = label;
    // Se anche a fontSize minimo non entra, tronca con ellisse mantenendo misura
    if (ctx.measureText(displayText).width > availableWidth) {
      while (displayText.length > 1 && ctx.measureText(displayText + '‚Ä¶').width > availableWidth) {
        displayText = displayText.slice(0, -1);
      }
      displayText = displayText + '‚Ä¶';
    }

    ctx.font = fontSpec;
    ctx.textBaseline = 'middle';
    ctx.lineWidth = Math.max(2, Math.round(fontSize / 4));
    ctx.strokeStyle = 'rgba(0,0,0,0.52)';
    ctx.strokeText(displayText, 0, 0);
    ctx.fillStyle = 'rgba(255,255,255,0.98)';
    ctx.fillText(displayText, 0, 0);
    ctx.restore();
  }

  // center cap with soft gradient and stroke
  ctx.beginPath();
  ctx.arc(0,0,r*0.18,0,Math.PI*2);
  const centerGrad = ctx.createRadialGradient(0,0, r*0.02, 0,0, r*0.18);
  centerGrad.addColorStop(0, 'rgba(255,255,255,0.98)');
  centerGrad.addColorStop(1, 'rgba(220,230,240,0.95)');
  ctx.fillStyle = centerGrad;
  ctx.fill();
  ctx.lineWidth = 6;
  ctx.strokeStyle = 'rgba(0,0,0,0.14)';
  ctx.stroke();

  ctx.restore();

  // outer ring and tick marks
  ctx.save();
  ctx.translate(cx, cy);
  ctx.beginPath();
  ctx.arc(0,0,r,0,Math.PI*2);
  ctx.lineWidth = 10;
  ctx.strokeStyle = 'rgba(255,255,255,0.10)';
  ctx.stroke();

  // small ticks between sectors
  ctx.lineWidth = 2;
  ctx.strokeStyle = 'rgba(255,255,255,0.12)';
  for (let i=0;i<n;i++){
    const a = i*slice;
    const x1 = Math.cos(a) * (r + 6);
    const y1 = Math.sin(a) * (r + 6);
    const x2 = Math.cos(a) * (r - 6);
    const y2 = Math.sin(a) * (r - 6);
    ctx.beginPath();
    ctx.moveTo(x1,y1);
    ctx.lineTo(x2,y2);
    ctx.stroke();
  }
  ctx.restore();
}

function applyConfigText(text){
  options = parseCfg(text);
  updateKpi();
  resultEl.style.display = 'none';
  draw();
  renderItemList();
  syncTextarea();
}

function syncTextarea(){
  // Sincronizza la textarea invisibile per il link condivisibile
  const lines = options.map(o => `${o.label} | ${o.weight}`);
  const cfgTA = document.createElement('input');
  cfgTA.id = 'cfg';
  cfgTA.style.display = 'none';
  const existing = document.getElementById('cfg');
  if (existing) existing.remove();
  cfgTA.value = lines.join('\n');
  document.body.appendChild(cfgTA);
}

function renderItemList(){
  itemListEl.innerHTML = '';
  const hues = getPalette(options.length || 1);
  
  options.forEach((item, idx) => {
    const div = document.createElement('div');
    div.className = 'item';
    
    const colorSquare = document.createElement('div');
    colorSquare.className = 'item-color';
    const hue = hues[idx] ?? 200;
    colorSquare.style.background = `hsl(${hue}, 72%, 48%)`;
    
    const content = document.createElement('div');
    content.className = 'item-content';
    
    const label = document.createElement('div');
    label.className = 'item-label';
    label.textContent = item.label;
    
    const weight = document.createElement('div');
    weight.className = 'item-weight';
    weight.textContent = `Peso: ${item.weight}`;
    
    content.appendChild(label);
    content.appendChild(weight);
    
    const actions = document.createElement('div');
    actions.className = 'item-actions';
    
    const editBtn = document.createElement('button');
    editBtn.className = 'secondary';
    editBtn.textContent = '‚úé';
    editBtn.title = 'Modifica';
    editBtn.addEventListener('click', () => editItem(idx));
    
    const deleteBtn = document.createElement('button');
    deleteBtn.className = 'secondary';
    deleteBtn.textContent = '‚úï';
    deleteBtn.title = 'Elimina';
    deleteBtn.addEventListener('click', () => deleteItem(idx));
    
    actions.appendChild(editBtn);
    actions.appendChild(deleteBtn);
    
    div.appendChild(colorSquare);
    div.appendChild(content);
    div.appendChild(actions);
    itemListEl.appendChild(div);
  });
}

function addItem(){
  const label = (newLabelInput.value || '').trim().slice(0, 60);
  const weight = parseFloat(newWeightInput.value) || 1;
  
  if (!label) {
    setResult("‚ö†Ô∏è Inserisci un'etichetta");
    return;
  }
  
  if (weight <= 0) {
    setResult("‚ö†Ô∏è Il peso deve essere > 0");
    return;
  }
  
  options.push({ label, weight });
  updateKpi();
  renderItemList();
  syncTextarea();
  
  newLabelInput.value = '';
  newWeightInput.value = '1';
  newLabelInput.focus();
  
  localStorage.setItem('wheel_cfg', optionsToText());
  draw();
  setResult(`‚úì Aggiunto: ${label}`);
}

function editItem(idx){
  const item = options[idx];
  const newLabel = prompt('Etichetta:', item.label);
  if (newLabel === null) return;
  
  const trimmedLabel = newLabel.trim().slice(0, 60);
  if (!trimmedLabel) {
    setResult("‚ö†Ô∏è Etichetta non pu√≤ essere vuota");
    return;
  }
  
  const newWeight = parseFloat(prompt('Peso:', item.weight.toString()));
  if (isNaN(newWeight) || newWeight <= 0) {
    setResult("‚ö†Ô∏è Peso deve essere > 0");
    return;
  }
  
  options[idx] = { label: trimmedLabel, weight: newWeight };
  updateKpi();
  renderItemList();
  syncTextarea();
  localStorage.setItem('wheel_cfg', optionsToText());
  draw();
  setResult(`‚úì Modificato: ${trimmedLabel}`);
}

function deleteItem(idx){
  if (!confirm('Sei sicuro di voler eliminare questo settore?')) return;
  
  const removed = options.splice(idx, 1);
  updateKpi();
  renderItemList();
  syncTextarea();
  localStorage.setItem('wheel_cfg', optionsToText());
  draw();
  setResult(`‚úì Eliminato: ${removed[0].label}`);
}

function optionsToText(){
  return options.map(o => `${o.label} | ${o.weight}`).join('\n');
}

function loadPreset(){
  options = parseCfg(PRESET_TEXT);
  updateKpi();
  resultEl.style.display = 'none';
  renderItemList();
  syncTextarea();
  localStorage.setItem('wheel_cfg', PRESET_TEXT);
  draw();
}

// ====== Shareable link ======
function currentConfigToUrl(){
  const text = optionsToText();
  const payload = btoa(unescape(encodeURIComponent(text)));
  const url = new URL(location.href);
  url.searchParams.set('cfg', payload);
  return url.toString();
}

function loadConfigFromUrl(){
  const url = new URL(location.href);
  const cfg = url.searchParams.get('cfg');
  if (!cfg) return false;
  try{
    const text = decodeURIComponent(escape(atob(cfg)));
    options = parseCfg(text);
    updateKpi();
    renderItemList();
    syncTextarea();
    localStorage.setItem('wheel_cfg', text);
    return true;
  }catch(e){
    return false;
  }
}

async function copyLink(){
  const url = currentConfigToUrl();
  try{
    await navigator.clipboard.writeText(url);
    setResult("‚úì Link copiato negli appunti");
    setTimeout(() => { resultEl.style.display = 'none'; }, 2500);
  }catch(e){
    const tmp = document.createElement('input');
    tmp.value = url;
    document.body.appendChild(tmp);
    tmp.select();
    document.execCommand('copy');
    tmp.remove();
    setResult("‚úì Link copiato (fallback)");
    setTimeout(() => { resultEl.style.display = 'none'; }, 2500);
  }
}

// ====== Staff lock ======
async function sha256Hex(str){
  const data = new TextEncoder().encode(str);
  const hashBuf = await crypto.subtle.digest('SHA-256', data);
  const hashArr = Array.from(new Uint8Array(hashBuf));
  return hashArr.map(b => b.toString(16).padStart(2,'0')).join('');
}

function setStaffUnlocked(unlocked){
  document.body.classList.toggle('staffUnlocked', unlocked);
  localStorage.setItem('staff_unlocked', unlocked ? '1' : '0');
  if (!unlocked) pwInput.value = "";
}

async function tryUnlock(){
  const pw = pwInput.value ?? "";
  const h = await sha256Hex(pw);
  if (h === STAFF_PASSWORD_SHA256_HEX){
    setStaffUnlocked(true);
    setResult("Area staff sbloccata.");
  }else{
    setResult("Password errata.");
  }
}

function lock(){
  setStaffUnlocked(false);
  setResult("Area staff bloccata.");
}

// ====== Spin ======
function reset(){
  angle = 0;
  resultEl.style.display = 'none';
  draw();
}

function spin(){
  if (spinning || options.length < 2) return;
  spinning = true;
  spinBtn.disabled = true;
  resultEl.style.display = 'none';

  const n = options.length;
  const slice = (Math.PI*2)/n;

  const idx = weightedPickIndex(options);

  const center = idx*slice + slice/2;
  const targetBase = (-Math.PI/2) - center;
  // increase spin intensity: more extra turns and longer duration
  const TWO_PI = Math.PI * 2;
  const extraTurns = 12 + Math.floor(crypto.getRandomValues(new Uint32Array(1))[0] % 7); // 12-18

  // normalize start angle so subsequent spins behave like the first
  let start = angle % TWO_PI;
  if (start < 0) start += TWO_PI;

  // base target (so selected slice lands under pointer), plus extra full turns
  let target = targetBase + extraTurns * TWO_PI;
  // ensure target is strictly greater than start so motion is always forward and consistent
  while (target <= start) target += TWO_PI;

  const delta = target - start;
  // reflect normalized start in global angle so draw() uses it immediately
  angle = start;

  const duration = 7000;
  const t0 = performance.now();
  function easeOutCubic(t){ return 1 - Math.pow(1 - t, 3); }

  function frame(t){
    const p = clamp((t - t0) / duration, 0, 1);
    angle = start + delta * easeOutCubic(p);
    draw();
    if (p < 1){
      requestAnimationFrame(frame);
    }else{
      // normalize stored angle to keep numbers small for next spin
      angle = target % TWO_PI;
      spinning = false;
      spinBtn.disabled = false;
      // Feedback aggiunto: delay per il risultato
      setTimeout(() => {
        showWinOverlay("üéâ " + options[idx].label);
      }, 100);
    }
  }
  requestAnimationFrame(frame);
}

// ====== Staff button behavior ======
function openStaff(){
  // Porta l'utente al pannello staff (seconda card)
  const cards = document.querySelectorAll('.card');
  if (cards.length > 1) cards[1].scrollIntoView({behavior:'smooth', block:'start'});
}

// ====== PWA register ======
if ('serviceWorker' in navigator){
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('sw.js').catch(() => {});
  });
}

// ====== Wire up ======
spinBtn.addEventListener('click', spin);
resetBtn.addEventListener('click', reset);
staffBtn.addEventListener('click', openStaff);

unlockBtn.addEventListener('click', tryUnlock);
pwInput.addEventListener('keydown', (e)=>{ if(e.key === 'Enter') tryUnlock(); });
lockBtn.addEventListener('click', lock);

addItemBtn.addEventListener('click', addItem);
newLabelInput.addEventListener('keydown', (e)=>{ if(e.key === 'Enter') addItem(); });
newWeightInput.addEventListener('keydown', (e)=>{ if(e.key === 'Enter') addItem(); });

// preset select/buttons
const presetSelect = document.getElementById('presetSelect');
const loadPresetBtn = document.getElementById('loadPresetBtn');
const savePresetBtn = document.getElementById('savePresetBtn');
const deletePresetBtn = document.getElementById('deletePresetBtn');
const clearBtn = document.getElementById('clearBtn');

renderPresetsDropdown();

loadPresetBtn?.addEventListener('click', () => { if (presetSelect?.value) loadPresetByName(presetSelect.value.trim()); });
// auto-load when selection changes
presetSelect?.addEventListener('change', (e) => { if (e.target.value) loadPresetByName(e.target.value.trim()); });
savePresetBtn?.addEventListener('click', saveNewPreset);
deletePresetBtn?.addEventListener('click', deleteSelectedPreset);
clearBtn?.addEventListener('click', clearOptions);

presetBtn.addEventListener('click', () => { loadPreset(); setResult("‚úì Preset ripristinato."); });
copyLinkBtn.addEventListener('click', copyLink);

// ====== Init config ======
const fromUrl = loadConfigFromUrl();
if (!fromUrl){
  const saved = localStorage.getItem('wheel_cfg');
  if (saved){
    applyConfigText(saved);
  }else{
    loadPreset();
  }
}else{
  renderItemList();
  draw();
}

// ====== Init staff lock state ======
const unlocked = localStorage.getItem('staff_unlocked') === '1';
setStaffUnlocked(unlocked);

// Assicurati che la lista sia visibile al caricamento
renderItemList();
</script>
</body>
</html>
